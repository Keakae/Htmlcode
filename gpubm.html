<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGPU Benchmark</title>
    <style>
        canvas {
            width: 640px;
            height: 480px;
            background-color: #000;
        }
        #status {
            font-size: 20px;
            color: green;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>WebGPU Benchmark</h1>
    <canvas id="gpuCanvas" width="640" height="480"></canvas>
    <div id="status">Initializing WebGPU...</div>

    <script type="module">
        async function initWebGPU() {
            const statusElem = document.getElementById('status');

            if (!navigator.gpu) {
                statusElem.innerText = 'WebGPU не поддерживается!';
                console.error('WebGPU не поддерживается!');
                return;
            }

            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                statusElem.innerText = 'WebGPU адаптер не найден.';
                console.error('WebGPU адаптер не найден.');
                return;
            }

            const device = await adapter.requestDevice();
            const canvas = document.getElementById('gpuCanvas');
            const context = canvas.getContext('webgpu');
            const format = navigator.gpu.getPreferredCanvasFormat();

            context.configure({
                device: device,
                format: format
            });

            const vertexShaderCode = `
            @vertex
            fn main(@builtin(vertex_index) VertexIndex: u32) -> @builtin(position) vec4<f32> {
                var positions = array<vec2<f32>, 4>(
                    vec2<f32>(-1.0, -1.0),
                    vec2<f32>( 1.0, -1.0),
                    vec2<f32>(-1.0,  1.0),
                    vec2<f32>( 1.0,  1.0)
                );
                let pos = positions[VertexIndex];
                return vec4<f32>(pos, 0.0, 1.0);
            }`;

            const fragmentShaderCode = `
            @fragment
            fn main(@builtin(position) fragCoord: vec4<f32>) -> @location(0) vec4<f32> {
                let color = vec4<f32>(fragCoord.x / ${canvas.width}.0, fragCoord.y / ${canvas.height}.0, 0.5, 1.0);
                return color;
            }`;

            const vertexModule = device.createShaderModule({ code: vertexShaderCode });
            const fragmentModule = device.createShaderModule({ code: fragmentShaderCode });

            const pipeline = device.createRenderPipeline({
                layout: 'auto',
                vertex: {
                    module: vertexModule,
                    entryPoint: 'main',
                    buffers: []
                },
                fragment: {
                    module: fragmentModule,
                    entryPoint: 'main',
                    targets: [{ format: format }]
                },
                primitive: {
                    topology: 'triangle-strip',
                    cullMode: 'none'
                }
            });

            function render() {
                const commandEncoder = device.createCommandEncoder();
                const textureView = context.getCurrentTexture().createView();

                const renderPassDescriptor = {
                    colorAttachments: [{
                        view: textureView,
                        loadOp: 'clear',
                        clearValue: { r: 0.0, g: 0.0, b: 0.0, a: 1.0 },
                        storeOp: 'store',
                    }]
                };

                const passEncoder = commandEncoder.beginRenderPass(renderPassDescriptor);
                passEncoder.setPipeline(pipeline);
                passEncoder.draw(4, 1, 0, 0);
                passEncoder.end();

                device.queue.submit([commandEncoder.finish()]);

                requestAnimationFrame(render);
            }

            statusElem.innerText = 'WebGPU успешно инициализирован!';
            render();
        }

        initWebGPU().catch(err => {
            document.getElementById('status').innerText = 'Ошибка инициализации WebGPU';
            console.error('Ошибка инициализации WebGPU:', err);
        });
    </script>
</body>
</html>
